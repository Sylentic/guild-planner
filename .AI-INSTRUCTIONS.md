# AI Development Instructions for Guild Planner

This file documents lessons learned, best practices, and required procedures when AI agents work on this codebase.

> **IMPORTANT**: This project uses **PowerShell** for all command-line operations (developing in Windows). Use PowerShell cmdlets (`Get-ChildItem`, `Remove-Item`, `Get-Content`, etc.) instead of Unix-style commands (`ls`, `rm`, `cat`, etc.). See the PowerShell Commands Reference section for details.

## Critical Lessons Learned

### 1. Permission System Accuracy

* **Issue**: The permission system has specific permission names that must match exactly
  * ✅ Use `settings_edit_roles` (not `settings_edit_permissions`)
  * ✅ Use `settings_view_permissions` to check visibility
  * When adding permission checks in UI, verify against `src/lib/permissions.ts` PERMISSIONS object
* **Fix When**: Checking if a user can access features like permissions management
* **Where**: `src/app/[group]/[game]/settings/page.tsx` and permission check calls

### 2. Admin Role Restoration After Backups

* **Issue**: When the database is restored from a backup, user roles can revert to previous states
* **Impact**: Users may lose admin privileges and can't change permissions
* **Solution**: Use `scripts/restore-admin-role.ps1` to restore admin status
* **When to Use**: After database restore operations if admins report permission denied errors
* **Requires**: Discord ID (from user profile) and group slug

### 3. Role Management Hierarchy

* **Roles**: `admin` > `officer` > `member` > `trial` > `pending`
* **Only admins** can:
  * Edit custom role permissions via `PermissionsSettings` component
  * Change any member's role except other admins
* **Officers** can:
  * Manage `member` and `trial` roles only
  * Cannot edit permissions (admins only)
* **Permission Check**: Always use `getRoleHierarchy()` when determining what roles can manage what

## Code Patterns to Follow

### Permission Checks

```typescript
// ✅ Correct: Check specific permission string
const canEditPermissions = hasPermission('settings_edit_roles');

// ❌ Wrong: Making up permission names or using inconsistent names
const canEditPermissions = hasPermission('settings_edit_permissions');
```

### Adding New Permissions

1. Define in `src/lib/permissions.ts` in the `PERMISSIONS` object
2. Add to appropriate role in `DEFAULT_ROLE_PERMISSIONS`
3. Add to `PermissionOverrides` type in `src/app/api/group/permissions/route.ts`
4. Add translations to language files in `public/locales/`
5. Create translation keys: `permissions.{permission_id}.name` and `permissions.{permission_id}.description`

### Database Migrations

* Migrations are in `supabase/migrations/`
* File naming: Sequential 3-digit numbers + underscore + descriptive name (e.g., `001_initial_schema.sql`)
* The baseline migration at `000_baseline.sql` is squashed from many migrations
* **Before editing existing migrations**: Check if they're in the baseline; if yes, edit `000_baseline.sql`
* **For new features**: Create new migration file with next sequential number
* Always test migrations in dev first: `.env.local.dev`

### Component Props and Permissions

When creating new settings/management components:

```typescript
interface ComponentProps {
  groupId: string;
  userRole: GroupRole;  // Always include user role for permission checks
  onSave?: (data: any) => Promise<void>;  // Optional callback
}
```

### External API Integration

**CRITICAL**: Before writing code to integrate a new external API:

1. **Test the API first** using Postman, curl, or a simple test script
2. **Verify the response format** - ensure it returns what you expect
3. **Check authentication** - test with your actual credentials/tokens
4. **Test error cases** - what happens if the API is down or returns errors?
5. **Verify rate limits** - will the API work at expected request volume?
6. **Only then implement** the production integration code

This approach prevents implementing code that can't work due to:

* Incorrect API endpoint URL
* Wrong authentication method
* Unexpected response format
* CORS issues
* Rate limiting problems
* API deprecation or breaking changes

**Example**: Test a Discord webhook before writing notification code:

```powershell
# Test with curl or Postman first
$body = @{
    content = "Test message"
} | ConvertTo-Json

$response = Invoke-WebRequest -Uri $webhookUrl -Method POST -Body $body -ContentType 'application/json'
Write-Host $response.StatusCode  # Should be 204
```

Once verified, implement the actual client code.

## Changelog and Documentation

### When to Update CHANGELOG

* ✅ New features added
* ✅ Bug fixes (especially permission/auth related)
* ✅ Database schema changes
* ✅ Breaking changes to APIs
* ❌ Don't update for: Internal refactors without user-facing changes, lint fixes

### Format

```markdown
## [Version] - YYYY-MM-DD

### Added
- New feature description

### Fixed
- Bug fix description

### Changed
- API or behavior change

### Security
- Security fix description
```

### Where to Add

* Create `CHANGELOG.md` in project root if it doesn't exist
* Add new entries at the top under `## [Unreleased]` section
* Update when merging to main/staging

## Testing Requirements

### Before Merging Any Changes

1. **Permission Checks**: Test that:
   * Users without permission can't see/use features
   * Users with correct role CAN access features
   * Role hierarchy is enforced correctly

2. **Database Changes**:
   * All migrations must be reversible
   * Test both up and down migrations
   * Verify data integrity after migration

3. **Component Changes**:
   * Test with different user roles
   * Test error states
   * Test loading states
   * Check accessibility

## Environment Setup

### Development vs Production

* **Dev**: Uses `.env.local.dev` and separate Supabase project
* **Prod**: Uses `.env.local` and production Supabase
* **Never test permission/role changes on prod without approval**
* Always test new permission features in dev first

### Required Environment Variables

```text
NEXT_PUBLIC_SUPABASE_URL=https://...supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=...
SUPABASE_SERVICE_ROLE_KEY=... (server-side only)
```

## Common Issues and Solutions

| Issue | Cause | Solution |
| --- | --- | --- |
| "Forbidden - user is not an admin" when changing permissions | User role is not `admin` | Use `restore-admin-role.ps1` script or have existing admin promote user |
| Permissions section not showing in settings | Wrong permission name checked (typo) | Verify permission string matches `src/lib/permissions.ts` |
| User can't see their own rank/role options | Permission check is correct but UI logic is wrong | Check `RoleManagement` component filter logic |
| Database migrations fail on prod | Baseline migration was edited after prod deployment | Always create new migration file, don't edit existing ones |
| Backup restore causes role loss | Backup was taken before role was set | Restore from backup taken at correct time OR manually restore roles using script |

## File Structure and Conventions

### Key Files to Know

* `src/lib/permissions.ts` - Single source of truth for permissions
* `src/hooks/usePermissions.ts` - Frontend permission checking
* `src/app/api/group/permissions/route.ts` - Backend permission API
* `supabase/migrations/000_baseline.sql` - Complete database schema
* `src/components/settings/PermissionsSettings.tsx` - Permissions UI
* `src/components/settings/RoleManagement.tsx` - Role change UI

### Translation Keys

All UI text should use translation keys. For permissions:

```text
permissions.{permission_id}.name - Display name
permissions.{permission_id}.description - Help text
```

## When Making Breaking Changes

1. **Update Documentation**: Add to `docs/` folder if needed
2. **Update Types**: Ensure TypeScript types are accurate (no `any` unless necessary)
3. **Database Schema**: Create migration, test up/down
4. **Translations**: Add keys to all language files in `public/locales/`
5. **CHANGELOG**: Document the breaking change clearly
6. **Communication**: Note in PR description what's changing and why

## Security Considerations

* ✅ Always verify user identity via token before permission changes
* ✅ Use Supabase service role key for admin operations (server-side only)
* ✅ Check user's group membership before allowing any modifications
* ✅ Validate role hierarchy before allowing role changes
* ❌ Never expose service role key to frontend
* ❌ Never trust user input for role/permission checks
* ❌ Never skip auth verification "for convenience"

## Useful Commands

### Local Development

```powershell
# Load dev environment
.\scripts\backup-dev-database.ps1  # Backup before major changes
```

### Production Admin Operations

```powershell
# Restore admin role after backup
.\scripts\restore-admin-role.ps1 -DiscordId "YOUR_DISCORD_ID" -GroupSlug "group-slug" -Environment prod
```

### PowerShell Commands Reference

**Prefer these PowerShell cmdlets over Unix-style commands:**

```powershell
# ✅ PowerShell - CORRECT
Get-ChildItem                  # ls, dir
Get-Content                    # cat
Remove-Item                    # rm, del
Copy-Item                      # cp
Move-Item                      # mv
New-Item -ItemType File        # touch
Test-Path                      # test -f
Select-Object -First 10        # head -n 10
Select-Object -Last 10         # tail -n 10
Get-Content | Select-Object -Last 10  # tail

# ❌ Unix commands - AVOID (don't use)
ls, dir, cat, rm, cp, mv, touch, tail, head
```

## Review Checklist for AI Agents

Before completing any task on this codebase:

* \[ ] Verified permission names match `src/lib/permissions.ts`
* \[ ] Tested permission checks with different user roles
* \[ ] Updated CHANGELOG if user-facing change
* \[ ] Added/updated translations if UI text changed
* \[ ] Followed existing code patterns and conventions
* \[ ] No hardcoded `any` types unless unavoidable
* \[ ] Database migrations are reversible (if applicable)
* \[ ] Tested in dev environment before suggesting prod changes
* \[ ] Verified role hierarchy is respected
* \[ ] Removed all console.log statements except error logging
* \[ ] PR description explains what changed and why

***

**Last Updated**: February 5, 2026

**Maintainer**: Development Team (Pandamonium Gaming)

For questions about these guidelines, check existing PRs and issues for context before asking.
